<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS - Виртуальный Ассистент с Mistral AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@100;200;300;400;500;600;700&display=swap");
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Roboto Mono", monospace;
        }

        body {
            background: #0a0e17;
            color: #00bcd4;
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(10, 14, 23, 0.8);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.3);
            border: 1px solid #00bcd4;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            color: #00bcd4;
            text-shadow: 0 0 15px rgba(0, 188, 212, 0.7);
            margin-bottom: 10px;
            letter-spacing: 5px;
        }

        .header p {
            color: #aed0d0;
            font-size: 18px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .api-section {
            background: rgba(0, 188, 212, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #00bcd4;
        }

        .api-section h2 {
            color: #00bcd4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-section h2 i {
            font-size: 24px;
        }

        .api-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-key-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid #00bcd4;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .api-key-input:focus {
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }

        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background: #00bcd4;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #0097a7;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(0, 188, 212, 0.3);
            color: #00bcd4;
        }

        .btn-secondary:hover {
            background: rgba(0, 188, 212, 0.5);
        }

        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #aed0d0;
        }

        .instructions {
            background: rgba(174, 208, 208, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #aed0d0;
            margin-top: 20px;
        }

        .instructions h3 {
            color: #00bcd4;
            margin-bottom: 15px;
        }

        .instructions ol {
            color: #aed0d0;
            padding-left: 20px;
            line-height: 1.6;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        .instructions a {
            color: #00bcd4;
            text-decoration: none;
        }

        .instructions a:hover {
            text-decoration: underline;
        }

        .provider-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .provider-btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #00bcd4;
            background: rgba(0, 0, 0, 0.3);
            color: #aed0d0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .provider-btn.active {
            background: #00bcd4;
            color: #000;
            font-weight: bold;
        }

        .voice-section {
            background: rgba(0, 188, 212, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #00bcd4;
            text-align: center;
        }

        .voice-section h2 {
            color: #00bcd4;
            margin-bottom: 15px;
        }

        .voice-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(0, 188, 212, 0.3);
            border: 2px solid #00bcd4;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            background: rgba(0, 188, 212, 0.5);
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: #00bcd4;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(0, 188, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0); }
        }

        .voice-btn i {
            font-size: 30px;
            color: #fff;
        }

        .voice-status {
            margin-top: 15px;
            color: #aed0d0;
            font-size: 16px;
        }

        .chat-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 1px solid #00bcd4;
            padding: 20px;
            height: 250px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
        }

        .user-message {
            background: rgba(0, 188, 212, 0.3);
            margin-left: auto;
            text-align: right;
        }

        .jarvis-message {
            background: rgba(174, 208, 208, 0.1);
            text-align: left;
        }

        .message-text {
            color: #fff;
            font-size: 16px;
            line-height: 1.4;
        }

        .error {
            color: #ff6b6b;
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }

        .voice-settings {
            background: rgba(0, 188, 212, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #00bcd4;
            margin-top: 20px;
        }

        .voice-settings h2 {
            color: #00bcd4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-settings h2 i {
            font-size: 24px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            align-items: center;
        }

        .settings-label {
            color: #aed0d0;
        }

        .settings-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, input[type="range"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #00bcd4;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            outline: none;
            flex: 1;
        }

        select:focus, input[type="range"]:focus {
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.5);
        }

        input[type="range"] {
            padding: 0;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00bcd4;
            cursor: pointer;
        }

        .value-display {
            min-width: 40px;
            text-align: center;
            color: #aed0d0;
        }

        .test-btn {
            margin-top: 15px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 32px;
            }
            
            .api-input-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .provider-selector {
                flex-direction: column;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>J.A.R.V.I.S.</h1>
            <p>Виртуальный ассистент с поддержкой Mistral AI</p>
        </div>
        
        <div class="main-content">
            <div class="api-section">
                <h2><i class="fas fa-key"></i> Настройка API ключа</h2>
                
                <div class="provider-selector">
                    <button class="provider-btn active" id="mistralBtn">Mistral AI</button>
                    <button class="provider-btn" id="openaiBtn">OpenAI</button>
                </div>
                
                <div class="api-input-container">
                    <input type="password" class="api-key-input" id="apiKeyInput" placeholder="Введите ваш Mistral API ключ">
                    <button class="btn" id="saveApiKey">Сохранить</button>
                </div>
                <div class="status" id="apiKeyStatus">API ключ не сохранен</div>
                
                <div class="instructions">
                    <h3>Как получить Mistral API ключ:</h3>
                    <ol>
                        <li>Перейдите на <a href="https://console.mistral.ai/api-keys/" target="_blank">console.mistral.ai/api-keys</a></li>
                        <li>Войдите в свой аккаунт или создайте новый</li>
                        <li>Нажмите "Create new key"</li>
                        <li>Скопируйте ключ и вставьте в поле выше</li>
                        <li>Нажмите "Сохранить"</li>
                    </ol>
                    <p>Mistral AI предлагает бесплатные запросы для начала работы!</p>
                </div>
            </div>
            
            <div class="voice-settings">
                <h2><i class="fas fa-voice"></i> Настройки голоса J.A.R.V.I.S.</h2>
                
                <div class="settings-grid">
                    <div class="settings-label">Голос:</div>
                    <div class="settings-control">
                        <select id="voiceSelect">
                            <option value="">Загрузка голосов...</option>
                        </select>
                    </div>
                    
                    <div class="settings-label">Скорость:</div>
                    <div class="settings-control">
                        <input type="range" id="rateInput" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="rateValue">1.0</span>
                    </div>
                    
                    <div class="settings-label">Высота тона:</div>
                    <div class="settings-control">
                        <input type="range" id="pitchInput" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="pitchValue">1.0</span>
                    </div>
                    
                    <div class="settings-label">Громкость:</div>
                    <div class="settings-control">
                        <input type="range" id="volumeInput" min="0" max="1" step="0.1" value="1">
                        <span class="value-display" id="volumeValue">1.0</span>
                    </div>
                </div>
                
                <button class="btn test-btn" id="testVoiceBtn">Тестировать голос</button>
            </div>
            
            <div class="voice-section">
                <h2>Голосовое управление</h2>
                <div class="voice-btn" id="voiceButton">
                    <i class="fas fa-microphone"></i>
                </div>
                <div class="voice-status" id="voiceStatus">Нажмите для активации микрофона</div>
                <div class="error" id="voiceError"></div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="message jarvis-message">
                    <div class="message-text">Для начала работы сохраните ваш Mistral API ключ.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Элементы DOM
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKey');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const voiceButton = document.getElementById('voiceButton');
        const voiceStatus = document.getElementById('voiceStatus');
        const voiceError = document.getElementById('voiceError');
        const chatContainer = document.getElementById('chatContainer');
        const mistralBtn = document.getElementById('mistralBtn');
        const openaiBtn = document.getElementById('openaiBtn');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateInput = document.getElementById('rateInput');
        const pitchInput = document.getElementById('pitchInput');
        const volumeInput = document.getElementById('volumeInput');
        const rateValue = document.getElementById('rateValue');
        const pitchValue = document.getElementById('pitchValue');
        const volumeValue = document.getElementById('volumeValue');
        const testVoiceBtn = document.getElementById('testVoiceBtn');
        
        // Переменные состояния
        let apiKey = '';
        let recognition = null;
        let isListening = false;
        let currentProvider = 'mistral'; // По умолчанию используем Mistral
        let synth = window.speechSynthesis;
        let voices = [];
        
        // Инициализация голосов
        function loadVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '';
            
            // Фильтруем мужские голоса для русского и английского
            const maleVoices = voices.filter(voice => 
                (voice.lang.startsWith('ru') || voice.lang.startsWith('en')) && 
                voice.name.toLowerCase().includes('male')
            );
            
            // Если мужских голосов нет, показываем все доступные
            const availableVoices = maleVoices.length > 0 ? maleVoices : voices;
            
            // Сортируем по языку и имени
            availableVoices.sort((a, b) => {
                if (a.lang < b.lang) return -1;
                if (a.lang > b.lang) return 1;
                if (a.name < b.name) return -1;
                if (a.name > b.name) return 1;
                return 0;
            });
            
            // Добавляем опции в выпадающий список
            availableVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                
                // Помечаем мужские голоса как выбранные по умолчанию
                if (voice.lang.startsWith('en') && voice.name.toLowerCase().includes('male')) {
                    option.selected = true;
                }
                
                voiceSelect.appendChild(option);
            });
            
            // Загружаем сохраненные настройки
            loadVoiceSettings();
        }
        
        // Загрузка сохраненных настроек голоса
        function loadVoiceSettings() {
            const savedVoice = localStorage.getItem('jarvisVoice');
            const savedRate = localStorage.getItem('jarvisRate');
            const savedPitch = localStorage.getItem('jarvisPitch');
            const savedVolume = localStorage.getItem('jarvisVolume');
            
            if (savedVoice) {
                voiceSelect.value = savedVoice;
            }
            
            if (savedRate) {
                rateInput.value = savedRate;
                rateValue.textContent = savedRate;
            }
            
            if (savedPitch) {
                pitchInput.value = savedPitch;
                pitchValue.textContent = savedPitch;
            }
            
            if (savedVolume) {
                volumeInput.value = savedVolume;
                volumeValue.textContent = savedVolume;
            }
        }
        
        // Сохранение настроек голоса
        function saveVoiceSettings() {
            localStorage.setItem('jarvisVoice', voiceSelect.value);
            localStorage.setItem('jarvisRate', rateInput.value);
            localStorage.setItem('jarvisPitch', pitchInput.value);
            localStorage.setItem('jarvisVolume', volumeInput.value);
        }
        
        // Озвучивание текста
        function speakText(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Находим выбранный голос
            const selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // Устанавливаем параметры голоса
            utterance.rate = parseFloat(rateInput.value);
            utterance.pitch = parseFloat(pitchInput.value);
            utterance.volume = parseFloat(volumeInput.value);
            
            // Джарвис-стиль: добавляем небольшую задержку перед началом речи
            setTimeout(() => {
                synth.speak(utterance);
            }, 300);
        }
        
        // Переключение провайдеров
        mistralBtn.addEventListener('click', () => {
            currentProvider = 'mistral';
            mistralBtn.classList.add('active');
            openaiBtn.classList.remove('active');
            apiKeyInput.placeholder = "Введите ваш Mistral API ключ";
            updateInstructions();
        });
        
        openaiBtn.addEventListener('click', () => {
            currentProvider = 'openai';
            openaiBtn.classList.add('active');
            mistralBtn.classList.remove('active');
            apiKeyInput.placeholder = "Введите ваш OpenAI API ключ";
            updateInstructions();
        });
        
        function updateInstructions() {
            const instructions = document.querySelector('.instructions');
            if (currentProvider === 'mistral') {
                instructions.innerHTML = `
                    <h3>Как получить Mistral API ключ:</h3>
                    <ol>
                        <li>Перейдите на <a href="https://console.mistral.ai/api-keys/" target="_blank">console.mistral.ai/api-keys</a></li>
                        <li>Войдите в свой аккаунт или создайте новый</li>
                        <li>Нажмите "Create new key"</li>
                        <li>Скопируйте ключ и вставьте в поле выше</li>
                        <li>Нажмите "Сохранить"</li>
                    </ol>
                    <p>Mistral AI предлагает бесплатные запросы для начала работы!</p>
                `;
            } else {
                instructions.innerHTML = `
                    <h3>Как получить OpenAI API ключ:</h3>
                    <ol>
                        <li>Перейдите на <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></li>
                        <li>Войдите в свой аккаунт OpenAI или создайте новый</li>
                        <li>Нажмите "Create new secret key"</li>
                        <li>Скопируйте ключ и вставьте в поле выше</li>
                        <li>Нажмите "Сохранить"</li>
                    </ol>
                `;
            }
        }
        
        // Проверка поддержки браузером Web Speech API
        function checkSpeechRecognitionSupport() {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ru-RU';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = function() {
                    isListening = true;
                    voiceButton.classList.add('listening');
                    voiceStatus.textContent = "Слушаю...";
                    voiceError.textContent = "";
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    addMessage(transcript, 'user');
                    processCommand(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('Ошибка распознавания:', event.error);
                    
                    let errorMessage = "Ошибка: ";
                    switch(event.error) {
                        case 'network':
                            errorMessage += "проблемы с сетью";
                            break;
                        case 'not-allowed':
                            errorMessage += "микрофон не разрешен";
                            break;
                        case 'service-not-allowed':
                            errorMessage += "сервис распознавания недоступен";
                            break;
                        default:
                            errorMessage += event.error;
                    }
                    
                    voiceError.textContent = errorMessage;
                    isListening = false;
                    voiceButton.classList.remove('listening');
                    voiceStatus.textContent = "Нажмите для активации микрофона";
                };
                
                recognition.onend = function() {
                    isListening = false;
                    voiceButton.classList.remove('listening');
                    voiceStatus.textContent = "Нажмите для активации микрофона";
                };
                
                return true;
            } else {
                voiceError.textContent = "Ваш браузер не поддерживает распознавание речи. Используйте Chrome или Edge.";
                voiceButton.style.opacity = "0.5";
                voiceButton.style.cursor = "not-allowed";
                return false;
            }
        }
        
        // Инициализация при загрузке
        window.addEventListener('load', () => {
            // Проверяем поддержку распознавания речи
            checkSpeechRecognitionSupport();
            
            // Загружаем API ключ и провайдера из localStorage, если есть
            const savedApiKey = localStorage.getItem('jarvisApiKey');
            const savedProvider = localStorage.getItem('aiProvider');
            
            if (savedApiKey) {
                apiKey = savedApiKey;
                apiKeyInput.value = savedApiKey;
                apiKeyStatus.textContent = "API ключ загружен";
                apiKeyStatus.style.color = "#4caf50";
                
                addMessage("API ключ загружен. Готов к работе.", 'jarvis');
            }
            
            if (savedProvider) {
                currentProvider = savedProvider;
                if (currentProvider === 'openai') {
                    openaiBtn.click();
                } else {
                    mistralBtn.click();
                }
            }
            
            // Загружаем голоса
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = loadVoices;
            }
            loadVoices();
        });
        
        // Обработчик кнопки сохранения API ключа
        saveApiKeyButton.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('jarvisApiKey', apiKey);
                localStorage.setItem('aiProvider', currentProvider);
                apiKeyStatus.textContent = "API ключ сохранен";
                apiKeyStatus.style.color = "#4caf50";
                addMessage(`API ключ успешно сохранен для ${currentProvider === 'mistral' ? 'Mistral AI' : 'OpenAI'}. Теперь вы можете использовать голосовые команды.`, 'jarvis');
            } else {
                apiKeyStatus.textContent = "Введите действительный API ключ";
                apiKeyStatus.style.color = "#f44336";
            }
        });
        
        // Обработчик кнопки микрофона
        voiceButton.addEventListener('click', () => {
            if (!apiKey) {
                addMessage("Сначала сохраните ваш API ключ.", 'jarvis');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Ошибка при запуске распознавания:', error);
                    voiceError.textContent = "Ошибка при запуске микрофона";
                }
            }
        });
        
        // Обновление значений ползунков
        rateInput.addEventListener('input', () => {
            rateValue.textContent = rateInput.value;
            saveVoiceSettings();
        });
        
        pitchInput.addEventListener('input', () => {
            pitchValue.textContent = pitchInput.value;
            saveVoiceSettings();
        });
        
        volumeInput.addEventListener('input', () => {
            volumeValue.textContent = volumeInput.value;
            saveVoiceSettings();
        });
        
        voiceSelect.addEventListener('change', () => {
            saveVoiceSettings();
        });
        
        // Тестирование голоса
        testVoiceBtn.addEventListener('click', () => {
            speakText("Добрый день, сэр. Я Джарвис, ваш голосовой помощник. Чем могу быть полезен?");
        });
        
        // Добавление сообщения в чат
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'jarvis-message');
            
            const messageText = document.createElement('div');
            messageText.classList.add('message-text');
            messageText.textContent = text;
            
            messageDiv.appendChild(messageText);
            chatContainer.appendChild(messageDiv);
            
            // Прокрутка вниз
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Озвучивание ответов JARVIS
            if (sender === 'jarvis') {
                speakText(text);
            }
        }
        
        // Отправка запроса к Mistral API
        async function askMistralAI(message) {
            try {
                const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'mistral-small-latest',
                        messages: [
                            {
                                role: 'system',
                                content: 'Ты JARVIS - голосовой ассистент из вселенной Marvel. Отвечай кратко, официально и по делу, как настоящий помощник Тони Старка. Будь полезным и дружелюбным. Отвечай на русском языке.'
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Ошибка API: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Ошибка при запросе к Mistral AI:', error);
                throw error;
            }
        }
        
        // Отправка запроса к OpenAI API
        async function askOpenAI(message) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'Ты JARVIS - голосовой ассистент из вселенной Marvel. Отвечай кратко, официально и по делу, как настоящий помощник Тони Старка. Будь полезным и дружелюбным. Отвечай на русском языке.'
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Ошибка API: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Ошибка при запросе к OpenAI:', error);
                throw error;
            }
        }
        
        // Обработка команд
        async function processCommand(command) {
            const lowerCommand = command.toLowerCase();
            
            // Локальные команды
            if (lowerCommand.includes('привет') || lowerCommand.includes('здравствуй')) {
                const response = "Привет, сэр. Чем могу помочь?";
                addMessage(response, 'jarvis');
                return;
            }
            else if (lowerCommand.includes('время')) {
                const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const response = `Сейчас ${time}`;
                addMessage(response, 'jarvis');
                return;
            }
            else if (lowerCommand.includes('дата')) {
                const date = new Date().toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const response = `Сегодня ${date}`;
                addMessage(response, 'jarvis');
                return;
            }
            else if (lowerCommand.includes('открой google')) {
                window.open("https://google.com", "_blank");
                const response = "Открываю Google";
                addMessage(response, 'jarvis');
                return;
            }
            else if (lowerCommand.includes('открой чат')) {
                window.open("https://chat.openai.com", "_blank");
                const response = "Открываю ChatGPT";
                addMessage(response, 'jarvis');
                return;
            }
            else if (lowerCommand.includes('википедия')) {
                const query = command.replace('википедия', '').trim();
                if (query) {
                    window.open(`https://ru.wikipedia.org/wiki/${encodeURIComponent(query)}`, "_blank");
                    const response = `Ищу "${query}" в Википедии`;
                    addMessage(response, 'jarvis');
                } else {
                    const response = "Пожалуйста, уточните, что искать в Википедии";
                    addMessage(response, 'jarvis');
                }
                return;
            }
            
            // Запрос к AI
            addMessage("Думаю...", 'jarvis');
            
            try {
                let response;
                if (currentProvider === 'mistral') {
                    response = await askMistralAI(command);
                } else {
                    response = await askOpenAI(command);
                }
                
                addMessage(response, 'jarvis');
            } catch (error) {
                console.error('Ошибка при запросе к AI:', error);
                let errorMessage = "Извините, произошла ошибка при обращении к AI. ";
                
                if (error.message.includes('401')) {
                    errorMessage += "Неверный API ключ. Пожалуйста, проверьте и введите корректный ключ.";
                } else if (error.message.includes('429')) {
                    errorMessage += "Превышен лимит запросов. Попробуйте позже.";
                } else if (error.message.includes('500') || error.message.includes('503')) {
                    errorMessage += "Сервер временно недоступен. Попробуйте позже.";
                } else {
                    errorMessage += "Проверьте ваш API ключ и подключение к интернету.";
                }
                
                addMessage(errorMessage, 'jarvis');
            }
        }
    </script>
</body>
</html>